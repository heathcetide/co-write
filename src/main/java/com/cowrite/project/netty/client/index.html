<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSocket æ–‡æ¡£ååŒç¼–è¾‘æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        textarea { width: 100%; height: 200px; margin-top: 10px; }
        .log { margin-top: 20px; height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; }
        .status { margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

<h2>WebSocket æ–‡æ¡£ååŒç¼–è¾‘æµ‹è¯•</h2>

<label for="userId">ç”¨æˆ·IDï¼š</label>
<input type="text" id="userId" value="user123" />

<label for="docId">æ–‡æ¡£IDï¼š</label>
<input type="text" id="docId" value="doc456" />

<button onclick="connectWebSocket()">è¿æ¥</button>
<span class="status" id="status">æœªè¿æ¥</span>

<h3>å‘é€æ“ä½œ</h3>
<label>æ“ä½œç±»å‹ï¼š</label>
<select id="operationType">
    <option value="insert">æ’å…¥</option>
    <option value="delete">åˆ é™¤</option>
</select>

<label>å†…å®¹ï¼š</label>
<input type="text" id="content" value="Hello" />

<label>ä½ç½®ï¼š</label>
<input type="number" id="index" value="0" />

<button onclick="sendOperation()">å‘é€æ“ä½œ</button>

<h3>å½“å‰æ–‡æ¡£å†…å®¹</h3>
<textarea id="documentContent" readonly>åˆå§‹å†…å®¹</textarea>

<h3>æ“ä½œæ—¥å¿—</h3>
<div id="log" class="log"></div>

<script>
    let ws = null;
    let userId = '';
    let docId = '';
    let documentContent = 'åˆå§‹å†…å®¹';
    let reconnectAttempts = 0;
    let maxReconnectAttempts = 5;
    let heartbeatInterval = 30000; // æ¯ 30 ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
    let heartbeatTimer = null;

    function log(message) {
        const logDiv = document.getElementById("log");
        logDiv.innerHTML += `<div>> ${message}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function setStatus(status) {
        const statusDiv = document.getElementById("status");
        statusDiv.textContent = status;
    }

    function connectWebSocket() {
        userId = document.getElementById("userId").value.trim();
        docId = document.getElementById("docId").value.trim();

        if (!userId || !docId) {
            alert("è¯·è¾“å…¥ç”¨æˆ·IDå’Œæ–‡æ¡£ID");
            return;
        }

        const wsUrl = "ws://localhost:8080/ws";
        ws = new WebSocket(wsUrl);

        ws.onopen = function () {
            log("âœ… WebSocket è¿æ¥æˆåŠŸ");
            setStatus("è¿æ¥æˆåŠŸ");
            reconnectAttempts = 0;

            // å‘é€åˆå§‹åŒ–ä¿¡æ¯
            ws.send(JSON.stringify({
                userId: userId,
                docId: docId,
                operationType: "init",
                content: "",
                index: 0
            }));

            // å¯åŠ¨å¿ƒè·³
            startHeartbeat();
        };

        ws.onmessage = function (event) {
            log("ğŸ“© æ”¶åˆ°æ¶ˆæ¯: " + event.data);

            try {
                const msg = JSON.parse(event.data);
                const opType = msg.operationType;
                const content = msg.content;
                const index = msg.index;

                if (opType === "insert") {
                    documentContent = insertText(documentContent, content, index);
                } else if (opType === "delete") {
                    documentContent = deleteText(documentContent, index, content.length);
                }

                document.getElementById("documentContent").value = documentContent;
            } catch (e) {
                log("âš ï¸ è§£ææ¶ˆæ¯å¤±è´¥: " + e.message);
            }
        };

        ws.onclose = function () {
            log("ğŸ”Œ WebSocket è¿æ¥å·²å…³é—­");
            setStatus("è¿æ¥å·²å…³é—­");

            stopHeartbeat();

            // å°è¯•è‡ªåŠ¨é‡è¿
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                log(`ğŸ” æ­£åœ¨å°è¯•é‡è¿ï¼ˆç¬¬ ${reconnectAttempts} æ¬¡ï¼‰`);
                setTimeout(connectWebSocket, 3000); // 3ç§’åé‡è¿
            } else {
                log("âŒ å·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œåœæ­¢è¿æ¥");
            }
        };

        ws.onerror = function (error) {
            log("âŒ WebSocket é”™è¯¯: " + error);
            ws.close();
        };
    }

    function startHeartbeat() {
        stopHeartbeat(); // é¿å…é‡å¤å¯åŠ¨
        heartbeatTimer = setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "ping", timestamp: Date.now() }));
                log("ğŸ’“ å‘é€å¿ƒè·³ ping");
            }
        }, heartbeatInterval);
    }

    function stopHeartbeat() {
        if (heartbeatTimer) {
            clearInterval(heartbeatTimer);
            heartbeatTimer = null;
        }
    }

    function sendOperation() {
        const opType = document.getElementById("operationType").value;
        const content = document.getElementById("content").value;
        const index = parseInt(document.getElementById("index").value);

        if (!ws || ws.readyState !== WebSocket.OPEN) {
            alert("WebSocket æœªè¿æ¥");
            return;
        }

        const message = {
            userId: userId,
            docId: docId,
            operationType: opType,
            content: content,
            index: index,
            timestamp: Date.now()
        };

        ws.send(JSON.stringify(message));
        log("ğŸ“¤ å·²å‘é€æ“ä½œ: " + JSON.stringify(message));
    }

    function insertText(text, insertContent, position) {
        return text.slice(0, position) + insertContent + text.slice(position);
    }

    function deleteText(text, position, length) {
        return text.slice(0, position) + text.slice(position + length);
    }
</script>

</body>
</html>